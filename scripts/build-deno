#!/usr/bin/env bash

set -exuo pipefail

cd "$(dirname "$0")/.."

rm -rf deno; mkdir deno
cp -rp src/* deno

# x-release-please-start-version
cat << EOF > deno/README.md
# OpenAI Node API Library - Deno build

This is a build produced from https://github.com/openai/openai-node â€“ please go there to read the source and docs, file issues, etc.

Usage:

\`\`\`ts
import OpenAI from "https://deno.land/x/openai@v4.57.1/mod.ts";

const client = new OpenAI();
\`\`\`

Note that in most Deno environments, you can also do this:

\`\`\`ts
import OpenAI from "npm:openai";
\`\`\`
EOF
# x-release-please-end

for file in LICENSE CHANGELOG.md; do
  if [ -e "${file}" ]; then cp "${file}" deno; fi
done
cp src/internal/shim-types.d.ts deno/internal/shim-types.ts

npm exec ts-node -T -- scripts/utils/denoify.ts
deno fmt deno
deno check deno/mod.ts
if [ -e deno_tests ]; then
  deno test deno_tests --allow-env
fi

# make sure that nothing crashes when we load the Deno module
(cd deno && deno run mod.ts)
